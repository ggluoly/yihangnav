<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贻点导航后台</title>
    <style>
        :root { --primary:#0b72f3; --bg:#f7f9fb; --text:#1d2939; --muted:#6b7280; }
        *{box-sizing:border-box;}
        body{margin:0;min-height:100vh;background:linear-gradient(180deg,#f6f8fb 0%,#eef1f5 100%);color:var(--text);font-family:"Inter","Segoe UI","Helvetica Neue",Arial,sans-serif;display:flex;}
        .admin-layout{width:100%;display:grid;grid-template-columns:250px 1fr;min-height:100vh;}
        .sidebar{background:linear-gradient(180deg,#1f2a38 0%,#151b24 100%);color:#e5e7eb;display:flex;flex-direction:column;padding:20px 0;}
        .sidebar .logo{padding:0 20px 16px;font-weight:800;font-size:18px;color:#4ade80;}
        .menu{list-style:none;padding:0;margin:0;}
        .section-title{padding:12px 20px 6px;font-size:15px;color:#e5e7eb;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;}
        .section-title.single{cursor:default;}
        .section-title .caret{font-size:12px;color:#9ca3af;transition:transform .2s ease;}
        .section-title.single .caret{display:none;}
        .section-title .nav-icon{width:16px;height:16px;margin-right:8px;display:inline-flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:14px;}
        .section-title .title-text{flex:1;}
        .menu-collapse{overflow:hidden;transition:max-height .2s ease;}
        .menu li{padding:12px 20px 12px 32px;color:#cbd5e1;font-size:14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background .15s ease,color .15s ease,padding-left .15s ease;}
        .menu li:hover{background:rgba(255,255,255,0.08);color:#fff;padding-left:36px;}
        .menu li.active{background:linear-gradient(90deg,rgba(74,222,128,0.18),transparent 70%);color:#fff;border-left:3px solid #4ade80;padding-left:36px;}
        .menu li.gradient-green{background:linear-gradient(90deg,rgba(74,222,128,0.35),rgba(74,222,128,0.12));color:#fff;border-left:3px solid #22c55e;}
        .nav-icon{width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:14px;}
        .main{display:flex;flex-direction:column;background:var(--bg);min-height:100vh;}
        .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:#1f2933;color:#e2e8f0;box-shadow:0 8px 18px rgba(0,0,0,0.22);}
        .links a{margin-right:14px;color:#cbd5e1;font-size:14px;text-decoration:none;}
        .links a:hover{color:#10b981;}
        .user-pill{display:inline-flex;align-items:center;gap:6px;background:transparent;color:#e2e8f0;padding:6px 8px;border-radius:10px;font-weight:600;position:relative;cursor:pointer;}
        .arrow{display:inline-block;width:10px;height:10px;border:solid #cbd5e1;border-width:0 2px 2px 0;transform:rotate(-135deg);transition:transform .2s ease,border-color .2s ease;margin-left:2px;}
        .dropdown-menu{display:none;position:absolute;top:110%;right:0;background:#fff;color:#0f172a;border:1px solid #e5e7eb;border-radius:8px;padding:8px 12px;box-shadow:0 10px 18px rgba(0,0,0,0.12);white-space:nowrap;z-index:10;}
        .dropdown-menu a{color:#0f172a;text-decoration:none;font-size:14px;}
        .content{padding:18px 18px 24px;min-height:calc(100vh - 56px);}
        .panel{background:#ffffff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(15,23,42,0.05);border:1px solid #e5e7eb;}
        .panel h3{margin:0 0 10px;font-size:16px;color:#0f172a;}
        .stats-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;}
        .stat-card{position:relative;background:#0f172a;border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(15,23,42,0.12);border:1px solid rgba(255,255,255,0.06);display:flex;gap:12px;align-items:center;min-height:118px;overflow:hidden;}
        .stat-card::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 20% 20%,rgba(255,255,255,0.08),transparent 40%),radial-gradient(circle at 80% 0%,rgba(255,255,255,0.08),transparent 35%);pointer-events:none;}
        .stat-card::after{content:"";position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,rgba(59,130,246,0.55),rgba(16,185,129,0.45));}
        .badge{width:46px;height:46px;border-radius:14px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#0f172a;box-shadow:0 12px 22px rgba(0,0,0,0.16);}
        .accent-blue{background:linear-gradient(135deg,#dbeafe,#93c5fd);} .accent-green{background:linear-gradient(135deg,#d1fae5,#a7f3d0);} .accent-purple{background:linear-gradient(135deg,#ede9fe,#c4b5fd);} .accent-orange{background:linear-gradient(135deg,#fff7ed,#fed7aa);} .accent-slate{background:linear-gradient(135deg,#e5e7eb,#d1d5db);} .accent-pink{background:linear-gradient(135deg,#ffe4e6,#fecdd3);} .stat-body{position:relative;z-index:1;display:flex;flex-direction:column;gap:4px;} .stat-title{font-size:16px;color:#f8fafc;margin:0;font-weight:800;letter-spacing:0.2px;} .stat-value{font-size:26px;font-weight:800;color:#cbd5e1;}
        .recent-table{width:100%;border-collapse:collapse;margin-top:10px;} .recent-table th,.recent-table td{padding:10px 12px;font-size:14px;color:#0f172a;border-bottom:1px solid #e5e7eb;text-align:left;} .recent-table th{color:#4b5563;font-weight:700;background:#f9fbfd;} .recent-table tr:hover td{background:#f3f6fb;}
    </style>
</head>
<body>
<div class="admin-layout">
    <aside class="sidebar">
        <div class="logo">贻点导航后台</div>
        <div class="section-title single" data-collapse="section-dashboard"><span class="nav-icon">📊</span><span class="title-text">仪表盘</span><span class="caret" id="caret-dashboard">ˇ</span></div>
        <div class="menu-collapse" id="section-dashboard">
            <ul class="menu">
                <li class="active gradient-green" data-module="dashboard">- <span class="nav-icon">🏠</span>仪表盘</li>
            </ul>
        </div>
        <div class="section-title single" data-collapse="section-cat"><span class="nav-icon">🗂</span><span class="title-text">分类管理</span><span class="caret" id="caret-cat">ˇ</span></div>
        <div class="menu-collapse" id="section-cat">
            <ul class="menu">
                <li data-module="category">- <span class="nav-icon">🗂</span>分类管理</li>
            </ul>
        </div>
        <div class="section-title single" data-collapse="section-link"><span class="nav-icon">🔗</span><span class="title-text">链接管理</span><span class="caret" id="caret-link">ˇ</span></div>
        <div class="menu-collapse" id="section-link">
            <ul class="menu">
                <li data-module="card">- <span class="nav-icon">🔗</span>链接管理</li>
            </ul>
        </div>
        <div class="section-title" data-collapse="section-system"><span class="nav-icon">⚙️</span><span class="title-text">系统设置</span><span class="caret" id="caret-system">ˇ</span></div>
        <div class="menu-collapse" id="section-system">
            <ul class="menu">
                <li data-module="config">- <span class="nav-icon">🛠</span>站点设置</li>
                <li data-module="backup">- <span class="nav-icon">💾</span>数据备份</li>
                <li data-module="meta">- <span class="nav-icon">🧠</span>元数据助手</li>
            </ul>
        </div>
        <div class="section-title" data-collapse="section-action"><span class="nav-icon">🛠</span><span class="title-text">操作</span><span class="caret" id="caret-action">ˇ</span></div>
        <div class="menu-collapse" id="section-action">
            <ul class="menu">
                <li data-module="log">- <span class="nav-icon">📄</span>日志</li>
                <li data-module="friend">- <span class="nav-icon">🤝</span>友链管理</li>
                <li data-module="ad">- <span class="nav-icon">📢</span>广告管理</li>
                <li data-module="user">- <span class="nav-icon">👤</span>用户管理</li>
                <li onclick="logout()">- <span class="nav-icon">🚪</span>退出登录</li>
            </ul>
        </div>
    </aside>
    <main class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:16px;">
                <div class="links"><a href="/" target="_blank">🏠 前台首页</a></div>
            </div>
            <div class="user-pill" id="currentUser">
                <span id="currentUserName">未登录</span>
                <span id="userArrow" class="arrow"></span>
                <div id="logoutMenu" class="dropdown-menu"><a href="javascript:void(0)" onclick="logout()">退出登录</a></div>
            </div>
        </div>
        <div class="content" id="contentHost"></div>
    </main>
</div>
<script>
    const api = (path) => '/api' + path;
    const tokenKey = 'yh_token';
    const lastModuleKey = 'yh_last_module';
    const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val ?? ''; };
    const toast = (msg) => console.log(msg);

    function headers() {
        const h = { 'Content-Type': 'application/json' };
        const t = localStorage.getItem(tokenKey);
        if (t) h['Authorization'] = 'Bearer ' + t;
        return h;
    }

    function logout() { localStorage.removeItem(tokenKey); window.location.href = '/admin/login.html'; }

    async function loadMe() {
        const res = await fetch(api('/auth/me'), { headers: headers() });
        if (!res.ok) return;
        const data = await res.json();
        if (data.success && data.data && data.data.username) setText('currentUserName', data.data.username);
    }

    async function loadConfig() {
        const res = await fetch(api('/admin/config'), { headers: headers() });
        if (!res.ok) return;
        const data = await res.json();
        if (data.success) {
            if (document.getElementById('siteTitle')) document.getElementById('siteTitle').value = data.data['site.title'] || '';
            if (document.getElementById('siteBg')) document.getElementById('siteBg').value = data.data['site.background'] || '';
            if (document.getElementById('adsEnabled')) document.getElementById('adsEnabled').value = (data.data['ads.enabled'] || 'true');
            setText('cfgTitle', data.data['site.title'] || '-');
        }
    }

    async function loadStats() {
        const res = await fetch(api('/admin/stats'), { headers: headers() });
        if (!res.ok) return;
        const data = await res.json();
        if (data.success) {
            setText('statUsers', data.data.userCount);
            setText('statSearch', data.data.searchCount);
            setText('statBackup', data.data.backupCount);
            setText('statCat', data.data.categoryCount);
            setText('statCard', data.data.cardCount);
            setText('statFriend', data.data.friendCount);
            const recentTable = document.getElementById('recentLoginTable');
            if (recentTable) {
                recentTable.innerHTML = '';
                (data.data.recentLogins || []).forEach(item => {
                    const formatted = item.lastLoginAtFormatted || (item.lastLoginAt ? item.lastLoginAt.replace('T',' ').replace(/-/g,'/').replace(/\.\d+/, '') : '');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatted || '时间未知'}</td>
                        <td>${item.lastLoginIp || 'IP未知'}</td>
                        <td>${item.lastLoginUa || '浏览器未知'}</td>
                    `;
                    recentTable.appendChild(tr);
                });
            }
        }
    }

    async function loadCategories() {
        try {
            const res = await fetch(api('/admin/categories'), { headers: headers() });
            if (!res.ok) { console.error('loadCategories failed', res.status); return; }
            const data = await res.json();
            if (!data.success || !Array.isArray(data.data)) { console.warn('loadCategories: empty or invalid'); return; }

            const nameMap = new Map();
            data.data.forEach(c => nameMap.set(Number(c.id), c.name));

            const normalized = data.data.map(c => {
                const idNum = Number(c.id);
                const parentIdRaw = (c.parent && c.parent.id !== undefined) ? c.parent.id : (c.parentId === '' ? null : (c.parentId ?? null));
                const parsedPid = Number(parentIdRaw);
                let parentId = (parentIdRaw === null || parentIdRaw === undefined || !Number.isFinite(parsedPid)) ? 0 : parsedPid;
                if (parentId && !nameMap.has(parentId)) parentId = 0;
                const parentName = (c.parent && c.parent.name) || c.parentName || (parentId !== 0 ? nameMap.get(parentId) || `ID ${parentId}` : '');
                const iconClass = c.icon || c.iconClass || '';
                const description = c.description || '';
                return { ...c, id: idNum, parentId, parentName, iconClass, description };
            });
            window.__catList = normalized;
            if (typeof window.renderCategoryTree === 'function') {
                window.renderCategoryTree(normalized);
            } else {
                console.warn('renderCategoryTree not ready');
            }
        } catch (e) {
            console.error('loadCategories error', e);
        }
    }

    async function updateCategoryParent(id, newParentId) {
        const body = { parentId: newParentId || null };
        if (newParentId) body.parent = { id: newParentId };
        await fetch(api('/admin/categories/' + id), { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
    }

    async function deleteCategory(id) {
        if (!confirm('确定删除该分类？')) return;
        const res = await fetch(api('/admin/categories/' + id), { method: 'DELETE', headers: headers() });
        if (res.ok) { toast('分类已删除'); await loadCategories(); }
        else { const data = await res.json().catch(() => ({})); alert(data.message || '删除失败'); }
    }

    async function createCategory() {
        const nameVal = (document.getElementById('catName')?.value || '').trim();
        if (!nameVal) { alert('名称必填'); return; }
        const body = {
            name: nameVal,
            icon: document.getElementById('catDesc')?.value || '',
            description: document.getElementById('catMemo')?.value || '',
            sortOrder: Number(document.getElementById('catSort')?.value || 0)
        };
        const parentId = document.getElementById('catParent')?.value;
        if (parentId) {
            const pid = Number(parentId);
            body.parentId = pid;
            body.parent = { id: pid };
        }
        const catId = document.getElementById('catId')?.value;
        const url = catId ? api('/admin/categories/' + catId) : api('/admin/categories');
        const method = catId ? 'PUT' : 'POST';
        try {
            const res = await fetch(url, { method, headers: headers(), body: JSON.stringify(body) });
            const data = await res.json();
            if (data.success) {
                toast(catId ? '分类已更新' : '分类已创建');
                if (document.getElementById('catId')) document.getElementById('catId').value = '';
                await loadCategories();
            } else {
                alert(data.message || '操作失败');
            }
        } catch (err) {
            console.error('createCategory error', err);
            alert('请求失败，请重试');
        }
    }

    async function loadBackups() {
        const res = await fetch(api('/admin/backups'), { headers: headers() });
        const container = document.getElementById('backupList');
        if (container) container.innerHTML = '';
        if (!res.ok || !container) return;
        const data = await res.json();
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div>
                        <div>${item.fileName}</div>
                        <div class="muted">${(item.fileSize/1024/1024).toFixed(2)} MB · ${item.type}</div>
                    </div>
                    <button class="secondary" onclick="deleteBackup(${item.id})">删除</button>
                `;
                container.appendChild(div);
            });
        }
    }

    async function triggerBackup() {
        const res = await fetch(api('/admin/backups'), { method: 'POST', headers: headers() });
        const data = await res.json();
        if (data.success) toast('备份完成'); else alert(data.message || '备份失败');
        await loadBackups();
    }
    async function deleteBackup(id) { await fetch(api('/admin/backups/' + id), { method: 'DELETE', headers: headers() }); await loadBackups(); }
    async function restoreBackup() {
        const fileInput = document.getElementById('restoreFile'); if (!fileInput || !fileInput.files[0]) return;
        const form = new FormData(); form.append('file', fileInput.files[0]);
        const res = await fetch(api('/admin/backups/restore'), { method: 'POST', headers: { 'Authorization': headers()['Authorization'] }, body: form });
        const data = await res.json(); if (data.success) toast('恢复完成'); else alert(data.message || '恢复失败');
    }

    async function fetchMeta() {
        const url = document.getElementById('metaUrl')?.value; if (!url) return;
        const res = await fetch(api('/admin/cards/metadata?url=') + encodeURIComponent(url), { headers: headers() });
        const data = await res.json();
        setText('metaResult', data.success ? `标题: ${(data.data.title||'-')} / 描述: ${(data.data.description||'-')} / Logo: ${(data.data.logo||'-')}` : data.message || '获取失败');
    }

    async function loadCardConfig(name) {
        switch (name) {
            case 'dashboard': await loadStats(); break;
            case 'config': await loadConfig(); break;
            case 'backup': await loadBackups(); break;
            case 'category': await loadCategories(); break;
            case 'card': await searchCards(); break;
            case 'ad': await loadAds(); break;
            case 'friend': await loadFriends(); break;
            case 'user': await loadUsers(); break;
            default: break;
        }
    }

    async function loadAds() {
        const res = await fetch(api('/admin/ads'), { headers: headers() });
        const list = document.getElementById('adList');
        if (list) list.innerHTML = '';
        if (!res.ok || !list) return;
        const data = await res.json();
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(ad => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div>${ad.position} - ${ad.title}</div><div class="muted">${ad.linkUrl || ''}</div>`;
                list.appendChild(item);
            });
        }
    }

    async function loadFriends() {
        const res = await fetch(api('/admin/friends'), { headers: headers() });
        const list = document.getElementById('friendList');
        if (list) list.innerHTML = '';
        if (!res.ok || !list) return;
        const data = await res.json();
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(f => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div>${f.title}</div><div class="muted">${f.url}</div>`;
                list.appendChild(item);
            });
        }
    }

    async function createFriend() {
        const body = {
            title: document.getElementById('linkTitle')?.value || '',
            url: document.getElementById('linkUrl')?.value || '',
            logo: document.getElementById('linkLogo')?.value || '',
            sortOrder: Number(document.getElementById('linkSort')?.value || 0)
        };
        const res = await fetch(api('/admin/friends'), { method: 'POST', headers: headers(), body: JSON.stringify(body) });
        const data = await res.json();
        if (data.success) toast('友链已创建'); else alert(data.message || '创建失败');
        await loadFriends();
    }

    async function createAd() {
        const body = {
            position: document.getElementById('adPos')?.value || '',
            title: document.getElementById('adTitle')?.value || '',
            imageUrl: document.getElementById('adImg')?.value || '',
            linkUrl: document.getElementById('adLink')?.value || ''
        };
        const res = await fetch(api('/admin/ads'), { method: 'POST', headers: headers(), body: JSON.stringify(body) });
        const data = await res.json();
        if (data.success) toast('广告已创建'); else alert(data.message || '创建失败');
        await loadAds();
    }

    async function createCard() {
        const body = {
            title: document.getElementById('cardTitle')?.value || '',
            url: document.getElementById('cardUrl')?.value || '',
            description: document.getElementById('cardDesc')?.value || '',
            logo: document.getElementById('cardLogo')?.value || '',
            sortOrder: Number(document.getElementById('cardSort')?.value || 0)
        };
        const catId = Number(document.getElementById('cardCatId')?.value || 0);
        if (catId) body.category = { id: catId };
        const res = await fetch(api('/admin/cards'), { method: 'POST', headers: headers(), body: JSON.stringify(body) });
        const data = await res.json();
        if (data.success) toast('卡片已创建'); else alert(data.message || '创建失败');
        await searchCards();
    }

    async function loadUsers() {
        const res = await fetch(api('/admin/users'), { headers: headers() });
        const list = document.getElementById('userList');
        if (list) list.innerHTML = '';
        if (!res.ok || !list) return;
        const data = await res.json();
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(u => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div>${u.username}</div><div class="muted">${u.role || ''}</div>`;
                list.appendChild(item);
            });
        }
    }

    async function searchCards() {
        const kw = document.getElementById('cardKeyword')?.value || '';
        const list = document.getElementById('cardList');
        if (!list) return; list.innerHTML = '';
        if (!kw) return;
        const res = await fetch(api('/admin/cards/search?keyword=') + encodeURIComponent(kw), { headers: headers() });
        const data = await res.json();
        if (data.success && Array.isArray(data.data)) {
            data.data.forEach(card => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<div>#${card.id} ${card.title} <span class="muted">${card.url}</span></div><div class="muted">${card.description || ''}</div>`;
                list.appendChild(item);
            });
        }
    }

    async function loadModule(name) {
        const container = document.getElementById('contentHost');
        if (!container) return;
        const res = await fetch(`/admin/modules/${name}.html`);
        container.innerHTML = await res.text();
        const scripts = Array.from(container.querySelectorAll('script'));
        scripts.forEach(s => {
            const newScript = document.createElement('script');
            if (s.src) newScript.src = s.src; else newScript.textContent = s.innerHTML;
            document.body.appendChild(newScript); document.body.removeChild(newScript);
        });
        await loadCardConfig(name);
        localStorage.setItem(lastModuleKey, name);
        setActiveMenu(name);
    }

    function setActiveMenu(name) {
        const menuItems = document.querySelectorAll('[data-module]');
        menuItems.forEach(i => {
            const isMatch = i.getAttribute('data-module') === name;
            i.classList.toggle('active', isMatch);
            i.classList.toggle('gradient-green', isMatch);
        });
    }

    (async () => {
        if (!localStorage.getItem(tokenKey)) { window.location.href = '/admin/login.html'; return; }
        await loadMe();
        const initial = localStorage.getItem(lastModuleKey) || 'dashboard';
        await loadModule(initial);
        const menuItems = document.querySelectorAll('[data-module]');
        menuItems.forEach(item => {
            item.addEventListener('click', async () => { await loadModule(item.getAttribute('data-module')); });
        });
        document.querySelectorAll('[data-collapse]').forEach(header => {
            const skipCollapse = header.classList.contains('single');
            const targetId = header.getAttribute('data-collapse');
            const panel = document.getElementById(targetId);
            const caret = header.querySelector('.caret');
            if (!panel) return;
            panel.style.overflow = 'hidden';
            panel.style.maxHeight = panel.scrollHeight + 'px';
            if (skipCollapse) { if (caret) caret.style.display = 'none'; return; }
            if (caret) caret.innerText = 'ˇ';
            header.addEventListener('click', () => {
                const isOpen = panel.style.maxHeight && panel.style.maxHeight !== '0px';
                if (isOpen) { panel.style.maxHeight = '0px'; if (caret) caret.innerText = '>'; }
                else { panel.style.maxHeight = panel.scrollHeight + 'px'; if (caret) caret.innerText = 'ˇ'; }
            });
        });
        (function setupLogoutHover() {
            const userPill = document.getElementById('currentUser');
            const menu = document.getElementById('logoutMenu');
            const arrow = document.getElementById('userArrow');
            let timer = null;
            if (userPill && menu) {
                const show = () => { if (timer) clearTimeout(timer); menu.style.display = 'block'; if (arrow) { arrow.style.transform = 'rotate(45deg)'; arrow.style.borderColor = '#10b981'; } userPill.style.color = '#10b981'; };
                const hide = () => { timer = setTimeout(() => { menu.style.display = 'none'; if (arrow) { arrow.style.transform = 'rotate(-135deg)'; arrow.style.borderColor = '#cbd5e1'; } userPill.style.color = '#e2e8f0'; }, 150); };
                userPill.addEventListener('mouseenter', show);
                userPill.addEventListener('mouseleave', hide);
                menu.addEventListener('mouseenter', show);
                menu.addEventListener('mouseleave', hide);
            }
        })();
    })();
</script>
</body>
</html>
