<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
<style>
    .cat-page { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 16px rgba(15,23,42,0.05); border:1px solid #e5e7eb; }
    .cat-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .cat-header h3 { margin:0; display:flex; align-items:center; gap:8px; font-size:16px; }
    .cat-actions { display:flex; gap:8px; }
    .cat-btn { border:none; border-radius:10px; padding:8px 12px; background:#0b72f3; color:#fff; cursor:pointer; font-weight:600; font-size:14px; box-shadow:0 8px 16px rgba(11,114,243,0.15); }
    .cat-btn.secondary { background:#e5e7eb; color:#111827; box-shadow:none; }
    .cat-btn:active { transform:scale(0.98); }
    .tree-list { list-style:none; padding-left:0; margin:0; }
    .tree-list .node { margin-bottom:8px; }
    .tree-list .item { display:flex; align-items:center; gap:16px; padding:14px 16px; border-radius:14px; border:1px solid #e5e7eb; background:linear-gradient(135deg,#f9fbfd 0%,#f5f7fb 100%); position:relative; cursor:grab; box-shadow:0 6px 14px rgba(15,23,42,0.05); transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .tree-list .item:hover { transform:translateY(-2px); box-shadow:0 10px 18px rgba(15,23,42,0.08); border-color:#d0d7e2; }
    .tree-list .item:active { cursor:grabbing; }
    .tree-list .item.selected { border-color:#0b72f3; box-shadow:0 0 0 2px rgba(11,114,243,0.25), 0 10px 18px rgba(15,23,42,0.1); }
    .tree-list .item .line { position:absolute; left:-16px; top:0; bottom:0; width:1px; background:#e5e7eb; }
    .tree-children { list-style:none; padding-left:24px; margin:8px 0 0 0; border-left:1px solid #e5e7eb; }
    .tag { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; color:#1f2937; border-radius:10px; font-size:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); border:1px solid #dfe4ff; flex-shrink:0; }
    .muted { color:#6b7280; font-size:13px; }
    .desc { max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cat-name { font-weight:800; font-size:16px; color:#0f172a; letter-spacing:0.2px; }
    .ops { display:flex; gap:8px; margin-left:auto; }
    .ops button { border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:12px; }
    .ops .edit { background:#e0f2fe; color:#0b72f3; }
    .ops .del { background:#fee2e2; color:#b91c1c; }
    .cat-dialog-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:999; }
    .cat-dialog { background:#fff; border-radius:14px; padding:18px; width:420px; box-shadow:0 12px 28px rgba(0,0,0,0.18); }
    .cat-dialog h4 { margin:0 0 12px; font-size:16px; }
    .form-row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .form-row label { font-size:13px; color:#374151; font-weight:600; }
    .form-row input, .form-row select, .form-row textarea { padding:9px 10px; border-radius:10px; border:1px solid #d1d5db; font-size:14px; }
    .dialog-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
    .icon-panel { margin-top:8px; display:grid; grid-template-columns:repeat(8, minmax(0,1fr)); gap:10px; padding:12px; border:1px solid #e5e7eb; border-radius:14px; background:linear-gradient(180deg,#f9fafc 0%,#f3f6fb 100%); box-shadow:0 10px 20px rgba(0,0,0,0.08); max-height: 12.5rem; overflow-y: auto; }
    .icon-item { width:100%; aspect-ratio:1; border:1px solid transparent; border-radius:14px; display:flex; align-items:center; justify-content:center; cursor:pointer; background:#fff; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease; color:#0f172a; }
    .icon-item i { font-size:16px; }
    .icon-item:hover { transform:translateY(-2px); box-shadow:0 8px 14px rgba(0,0,0,0.08); border-color:#0b72f3; }
    .icon-item.active { border-color:#0b72f3; box-shadow:0 0 0 2px rgba(11,114,243,0.18); }
    .ctx-menu { position:fixed; z-index:1000; display:none; min-width:150px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 24px rgba(0,0,0,0.12); padding:6px 0; }
    .ctx-menu button { width:100%; background:transparent; border:none; text-align:left; padding:8px 12px; font-size:13px; color:#111827; cursor:pointer; }
    .ctx-menu button:hover { background:#f1f5f9; color:#0b72f3; }
    .ctx-menu .danger { color:#dc2626; }
</style>

<div class="cat-page">
    <div class="cat-header">
        <h3><i class="fas fa-sitemap"></i> 分类管理</h3>
        <div class="cat-actions">
            <button class="cat-btn" onclick="openCatDialog()">新增分类</button>
            <button class="cat-btn secondary" onclick="loadCategories()">刷新</button>
        </div>
    </div>
    <ul class="tree-list sortable" id="catTreeRoot">
        <li class="muted" id="catEmpty">加载中...</li>
    </ul>
</div>

<div class="cat-dialog-backdrop" id="catDialogMask">
    <div class="cat-dialog">
        <h4 id="dialogTitle">新增分类</h4>
        <input type="hidden" id="catId">
        <div class="form-row">
            <label for="catName">名称</label>
            <input id="catName" placeholder="请输入分类名称">
        </div>
        <div class="form-row">
            <label for="catParent">上级分类</label>
            <select id="catParent"></select>
        </div>
        <div class="form-row">
            <label>图标（面板选择或自定义）</label>
            <input id="catDesc" placeholder="自定义图标类名，如 fas fa-star" style="margin-top:6px;">
            <div class="icon-panel" id="iconPanel"></div>
        </div>
        <div class="form-row">
            <label for="catSort">排序（数字越小越靠前）</label>
            <input id="catSort" type="number" value="0">
        </div>
        <div class="form-row">
            <label for="catMemo">描述</label>
            <textarea id="catMemo" rows="3" placeholder="填写分类描述"></textarea>
        </div>
        <div class="dialog-actions">
            <button class="cat-btn secondary" onclick="closeCatDialog()">取消</button>
            <button class="cat-btn" id="saveCatBtn">保存</button>
        </div>
    </div>
</div>

<div class="ctx-menu" id="catCtxMenu">
    <button id="ctxAddChild">➕ 添加子分类</button>
    <button id="ctxEdit">✏️ 编辑</button>
    <button id="ctxDelete" class="danger">❌ 删除</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const catTreeRoot = document.getElementById('catTreeRoot');
    const catEmpty = document.getElementById('catEmpty');
    const ctxMenu = document.getElementById('catCtxMenu');
    let ctxTargetId = null;
    let selectedItem = null;

    function updateParentOptions(selected, excludeId) {
        const sel = document.getElementById('catParent');
        if (!sel) return;
        sel.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = '无（顶级分类）';
        sel.appendChild(none);
        (window.__catList || []).forEach(cat => {
            if (excludeId && Number(excludeId) === Number(cat.id)) return;
            const opt = document.createElement('option');
            opt.value = cat.id;
            opt.textContent = cat.name;
            if (selected !== undefined && selected !== null && Number(selected) === Number(cat.id)) {
                opt.selected = true;
            }
            sel.appendChild(opt);
        });
    }

    function closeCatDialog() {
        const mask = document.getElementById('catDialogMask');
        if (mask) mask.style.display = 'none';
    }

    function openCatDialog(id, presetParentId) {
        const mask = document.getElementById('catDialogMask');
        const title = document.getElementById('dialogTitle');
        const cat = (window.__catList || []).find(c => Number(c.id) === Number(id));
        document.getElementById('catId').value = cat ? cat.id : '';
        document.getElementById('catName').value = cat ? (cat.name || '') : '';
        document.getElementById('catDesc').value = cat ? (cat.iconClass || '') : '';
        setIconActive(document.getElementById('catDesc').value || '');
        document.getElementById('catSort').value = cat ? (cat.sortOrder ?? 0) : 0;
        document.getElementById('catMemo').value = cat && cat.description ? cat.description : '';
        const parentVal = cat ? (cat.parentId || '') : (presetParentId || '');
        updateParentOptions(parentVal || '', cat ? cat.id : null);
        if (title) title.innerText = cat ? '编辑分类' : '新增分类';
        if (mask) mask.style.display = 'flex';
    }

    function buildIconCell(cat) {
        if (cat.iconClass) {
            return `<span class="tag"><i class="${cat.iconClass}"></i></span>`;
        }
        return `<span class="tag"><i class="fas fa-folder-open"></i></span>`;
    }

    function truncate(text, maxLen) { if (!text) return '暂无描述'; return text.length > maxLen ? text.slice(0, maxLen) + '…' : text; }

    function renderIconPanel() {
        const panel = document.getElementById('iconPanel');
        if (!panel) return;
        panel.innerHTML = '';
        const iconColors = ['#0ea5e9','#8b5cf6','#f97316','#10b981','#ef4444','#6366f1','#14b8a6'];
        const presetIcons = [
            'fas fa-star','fas fa-heart','fas fa-bookmark','fas fa-tags','fas fa-magic','fas fa-bolt','fas fa-fire','fas fa-gift','fas fa-trophy','fas fa-bullseye','fas fa-smile','fas fa-thumbtack',
            'fas fa-link','fas fa-folder','fas fa-book','fas fa-map','fas fa-compass','fas fa-paper-plane','fas fa-pen','fas fa-feather','fas fa-camera','fas fa-music','fas fa-gamepad','fas fa-guitar',
            'fas fa-home','fas fa-tree','fas fa-leaf','fas fa-sun','fas fa-cloud-sun','fas fa-umbrella','fas fa-plane','fas fa-ship','fas fa-truck','fas fa-car','fas fa-bus','fas fa-bicycle','fas fa-train',
            'fas fa-laptop-code','fas fa-desktop','fas fa-laptop','fas fa-tablet-alt','fas fa-mobile-alt','fas fa-keyboard','fas fa-tv','fas fa-headphones','fas fa-headset','fas fa-robot','fas fa-microchip','fas fa-memory','fas fa-hdd','fas fa-sd-card','fas fa-sim-card',
            'fas fa-cog','fas fa-wrench','fas fa-hammer','fas fa-paint-brush','fas fa-palette','fas fa-clipboard','fas fa-clipboard-check','fas fa-clipboard-list','fas fa-briefcase','fas fa-id-card','fas fa-id-badge',
            'fas fa-database','fas fa-digital-tachograph','fas fa-server','fas fa-user-shield','fas fa-user-lock','fas fa-lock','fas fa-lock-open','fas fa-key','fas fa-fingerprint','fas fa-shield-alt','fas fa-shield-virus',
            'fas fa-wifi','fas fa-signal','fas fa-network-wired','fas fa-ethernet','fas fa-project-diagram','fas fa-sitemap','fas fa-route','fas fa-stream','fas fa-code-branch','fas fa-sync','fas fa-share-alt','fas fa-share-alt-square',
            'fas fa-cloud','fas fa-cloud-download-alt','fas fa-cloud-upload-alt','fas fa-cloudscale','fas fa-cloudsmith','fas fa-cloudversify','fas fa-cloudflare',
            'fas fa-qrcode','fas fa-barcode','fas fa-terminal','fas fa-plug','fas fa-battery-full','fas fa-battery-half',
            'fas fa-phone','fas fa-phone-alt','fas fa-headphones-alt','fas fa-tty','fas fa-voicemail','fas fa-comment-dots','fas fa-comments','fas fa-sms','fas fa-envelope','fas fa-envelope-open','fas fa-mail-bulk','fas fa-paperclip',
            'fas fa-rocket','fas fa-gem','fas fa-brain','fas fa-lightbulb','fas fa-chart-bar','fas fa-bell','fas fa-bug','fas fa-anchor','fas fa-crosshairs','fas fa-eye','fas fa-eye-slash','fas fa-user-secret','fas fa-user-cog',
            'fas fa-shopping-cart','fas fa-coffee','fas fa-code','fas fa-newspaper','fas fa-school','fas fa-graduation-cap','fas fa-hands-helping','fas fa-cat','fas fa-dog','fas fa-paw','fas fa-dragon','fas fa-meteor'
        ];
        presetIcons.forEach((icon, idx) => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            const color = iconColors[idx % iconColors.length];
            div.style.background = `linear-gradient(135deg, ${color}22, ${color}11)`;
            div.style.borderColor = `${color}55`;
            div.innerHTML = `<i class="${icon}" style="color:${color};"></i>`;
            div.title = icon;
            div.onclick = () => { document.getElementById('catDesc').value = icon; setIconActive(icon); };
            panel.appendChild(div);
        });
        setIconActive(document.getElementById('catDesc')?.value || '');
    }

    function setIconActive(icon) { document.querySelectorAll('.icon-item').forEach(el => el.classList.toggle('active', el.title === icon)); }

    function showCtxMenu(x, y) {
        if (!ctxMenu) return;
        ctxMenu.style.display = 'block';
        const rect = ctxMenu.getBoundingClientRect();
        const vw = window.innerWidth, vh = window.innerHeight;
        ctxMenu.style.left = Math.min(x, vw - rect.width - 8) + 'px';
        ctxMenu.style.top = Math.min(y, vh - rect.height - 8) + 'px';
    }

    function clearSelected() { if (selectedItem) selectedItem.classList.remove('selected'); selectedItem = null; }

    function hideCtxMenu() { if (ctxMenu) ctxMenu.style.display = 'none'; clearSelected(); ctxTargetId = null; }

    document.addEventListener('click', hideCtxMenu);
    document.addEventListener('scroll', hideCtxMenu, true);
    if (ctxMenu) {
        document.getElementById('ctxAddChild').onclick = (e) => { e.stopPropagation(); if (ctxTargetId) openCatDialog(null, ctxTargetId); hideCtxMenu(); };
        document.getElementById('ctxEdit').onclick = (e) => { e.stopPropagation(); if (ctxTargetId) openCatDialog(ctxTargetId); hideCtxMenu(); };
        document.getElementById('ctxDelete').onclick = (e) => { e.stopPropagation(); if (ctxTargetId) deleteCategory(ctxTargetId); hideCtxMenu(); };
    }

    function renderTreeNode(cat, childrenMap, depth) {
        const li = document.createElement('li');
        li.className = 'node';
        li.dataset.id = cat.id;
        li.innerHTML = `
            <div class="item">
                ${depth > 0 ? '<span class="line"></span>' : ''}
                <span class="muted">${cat.sortOrder ?? 0}</span>
                <span class="cat-name">${cat.name || ''}</span>
                ${buildIconCell(cat)}
                <span class="muted desc" title="${(cat.description || '暂无描述').replace(/\"/g, '&quot;')}"><strong>描述：</strong>${truncate(cat.description || '暂无描述', 24)}</span>
                <div class="ops">
                    <button class="edit" onclick="event.stopPropagation(); openCatDialog(${cat.id});">编辑</button>
                    <button class="del" onclick="event.stopPropagation(); deleteCategory(${cat.id});">删除</button>
                </div>
            </div>
        `;
        const item = li.querySelector('.item');
        if (item) {
            item.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                ctxTargetId = cat.id;
                clearSelected();
                item.classList.add('selected');
                selectedItem = item;
                showCtxMenu(e.pageX, e.pageY);
            });
        }
        const children = childrenMap.get(cat.id) || [];
        if (children.length) {
            const ul = document.createElement('ul');
            ul.className = 'tree-children sortable';
            children.forEach(ch => ul.appendChild(renderTreeNode(ch, childrenMap, depth + 1)));
            li.appendChild(ul);
        }
        return li;
    }

    window.renderCategoryTree = function renderCategoryTree(list) {
        const data = list || [];
        window.__catList = data;
        renderIconPanel();
        if (!catTreeRoot) return;
        catTreeRoot.innerHTML = '';
        if (!data.length) {
            catTreeRoot.innerHTML = '<li class="muted">暂无分类数据</li>';
            updateParentOptions('');
            return;
        }
        const childrenMap = new Map();
        data.forEach(c => {
            const pidNum = Number(c.parentId);
            const pid = Number.isFinite(pidNum) && pidNum !== 0 ? pidNum : 0;
            if (!childrenMap.has(pid)) childrenMap.set(pid, []);
            childrenMap.get(pid).push(c);
        });
        childrenMap.forEach(arr => arr.sort((a,b) => {
            const sa = Number(a.sortOrder || 0), sb = Number(b.sortOrder || 0);
            if (sa !== sb) return sa - sb;
            return Number(a.id) - Number(b.id);
        }));
        (childrenMap.get(0) || []).forEach(cat => catTreeRoot.appendChild(renderTreeNode(cat, childrenMap, 0)));
        initSortable();
        updateParentOptions('');
    };

    // 保存按钮绑定全局 createCategory（来自 admin/index.html），完成后关闭弹窗并刷新
    const saveBtn = document.getElementById('saveCatBtn');
    if (saveBtn) {
        saveBtn.onclick = async () => {
            if (typeof createCategory === 'function') {
                await createCategory();
                closeCatDialog();
            }
        };
    }

    async function saveOrder(listEl, parentId) {
        const siblings = Array.from(listEl.querySelectorAll(':scope > li.node'));
        for (let i = 0; i < siblings.length; i++) {
            const id = Number(siblings[i].dataset.id);
            const body = { sortOrder: i };
            if (parentId && parentId !== 0) { body.parentId = parentId; body.parent = { id: parentId }; } else { body.parentId = null; }
            await fetch(api('/admin/categories/' + id), { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
        }
    }

    function initSortable() {
        const lists = document.querySelectorAll('.sortable');
        lists.forEach(list => {
            new Sortable(list, {
                group: 'cats',
                handle: '.item',
                animation: 150,
                onStart: () => hideCtxMenu(),
                onEnd: async (evt) => {
                    const parentUl = evt.to.closest('ul');
                    const parentLi = parentUl.closest('li.node');
                    const newParentId = parentLi ? Number(parentLi.dataset.id) : 0;
                    await saveOrder(parentUl, newParentId);
                    await loadCategories();
                }
            });
        });
    }
</script>
