<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />
    <title>贻点导航</title>
    <link rel="shortcut icon" href="./assets/images/favicon.png" />
    <link rel="stylesheet" id="block-library-css" href="./assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="./assets/css/iconfont-3.03029.1.css" type="text/css" media="all" />
    <link rel="stylesheet" id="bootstrap-css" href="./assets/css/bootstrap.min-4.3.1.css" type="text/css" media="all" />
    <link rel="stylesheet" id="fancybox-css" href="./assets/css/fancybox.min-3.5.7.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iowen-css" href="./assets/css/style-3.03029.1.css" type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="./assets/css/custom-style.css" type="text/css" media="all" />
    <link rel="stylesheet" id="fortawesome-css" href="./assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />
    <script src="./assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script src="./assets/js/content-search.js" id="content-search-js"></script>
</head>
<body class="io-grey-mode">
<div class="page-container">
    <div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width:170px">
        <div class="modal-dialog h-100 sidebar-nav-inner">
            <div class="sidebar-logo border-bottom border-color">
                <div class="logo overflow-hidden">
                    <a href="#" class="logo-expanded">
                        <img src="./assets/images/bt8-expand-light.png" height="40" class="logo-light" alt="贻点导航">
                        <img src="./assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none" alt="贻点导航">
                    </a>
                    <a href="#" class="logo-collapsed">
                        <img src="./assets/images/bt.png" height="40" class="logo-light" alt="贻点导航">
                        <img src="./assets/images/bt.png" height="40" class="logo-dark d-none" alt="贻点导航">
                    </a>
                </div>
            </div>
            <div class="sidebar-menu flex-fill">
                <div class="sidebar-scroll">
                    <div class="sidebar-menu-inner">
                        <ul id="sidebarMenu">
                            <li class="sidebar-item text-muted px-3 py-2">加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="border-top py-2 border-color">
                <div class="flex-bottom">
                    <ul>
                        <li class="sidebar-item">
                            <a href="/about" target="_blank"><i class="fas fa-file-upload icon-fw icon-lg mr-2"></i><span>网站提交</span></a>
                        </li>
                        <li class="sidebar-item">
                            <a href="#friendlink" class="smooth"><i class="fab fa-staylinked icon-fw icon-lg mr-2"></i><span>友情链接</span></a>
                        </li>
                        <li class="sidebar-item">
                            <a href="/about" target="_blank"><i class="fa fa-info-circle icon-fw icon-lg mr-2"></i><span>关于导航</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content flex-fill grid-bg">
        <div class="big-header-banner">
            <div id="header" class="page-header sticky">
                <div class="navbar navbar-expand-md">
                    <div class="container-fluid p-0">
                        <a href="#" class="navbar-brand d-md-none" title="贻点导航">
                            <img src="./assets/images/bt.png" class="logo-light" alt="贻点导航">
                            <img src="./assets/images/bt.png" class="logo-dark d-none" alt="贻点导航">
                        </a>

                        <div class="collapse navbar-collapse order-2 order-md-1">
                            <div class="header-mini-btn">
                                <label>
                                    <input id="mini-button" type="checkbox">
                                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                        <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                        <path class="line--2" d="M0 50h80"></path>
                                        <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                    </svg>
                                </label>
                            </div>

                            <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                                <li><a href="./"><i class="fa fa-home fa-lg mr-2"></i><span>首页</span></a></li>
                                <li><a href="./about"><i class="fa fa-book fa-lg mr-2"></i><span>关于</span></a></li>
                            </ul>

                            <div class="rounded-circle weather">
                                <div id="he-plugin-simple" style="display: contents;"></div>
                                <script>
                                    WIDGET = {CONFIG: {"modules":"01234","background":5,"tmpColor":"E4C600","tmpSize":14,"cityColor":"E4C600","citySize":14,"aqiColor":"#E4C600","aqiSize":14,"weatherIconSize":24,"alertIconSize":18,"padding":"10px 10px 10px 10px","shadow":"1","language":"auto","borderRadius":5,"fixed":"false","vertical":"middle","horizontal":"left","key":"085791e805a24491b43b06cf58ab31e7"}};
                                </script>
                                <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                            </div>
                        </div>

                        <ul class="nav navbar-menu text-xs order-1 order-md-2">
                            <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                                <script>
                                    fetch('https://v1.hitokoto.cn')
                                        .then(r => r.json())
                                        .then(data => {
                                            const h = document.getElementById('hitokoto_text');
                                            if (h) {
                                                h.href = 'https://hitokoto.cn/?uuid=' + data.uuid;
                                                h.innerText = data.hitokoto || '一言加载失败';
                                            }
                                        }).catch(console.error);
                                </script>
                                <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                            </li>
                            <li class="nav-search ml-3 ml-md-4">
                                <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i class="iconfont icon-search icon-2x"></i></a>
                            </li>
                            <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                                <a href="javascript:" id="sidebar-switch" data-toggle="modal" data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="placeholder" style="height:74px"></div>
        </div>

        <div class="header-big post-top css-color mb-4" id="search-bg">
            <div class="s-search">
                <div id="search" class="s-search mx-auto">
                    <form class="super-search-fm" action="https://www.baidu.com/s" method="get" target="_blank">
                        <input type="text" id="search-text" class="form-control smart-tips search-key" name="wd" placeholder="输入关键字搜索" autocomplete="off">
                        <button class="submit" type="submit"><i class="iconfont icon-search"></i></button>
                    </form>
                    <div class="card search-smart-tips search-hot-text">
                        <ul id="word" style="display:none"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="content" class="content-site customize-site">
            <div class="text-center text-muted py-5" id="loadingTip">正在加载数据...</div>
        </div>

        <footer class="main-footer footer-type-1 text-xs">
            <div id="footer-tools" class="d-flex flex-column">
                <a href="javascript:" id="go-to-up" class="btn rounded-circle go-up m-1" rel="go-top"><i class="iconfont icon-to-up"></i></a>
                <a href="javascript:" data-toggle="modal" data-target="#search-modal" class="btn rounded-circle m-1" rel="search"><i class="iconfont icon-search"></i></a>
                <a href="javascript:" onclick="switchNightMode()" class="btn rounded-circle switch-dark-mode m-1" id="yejian" data-toggle="tooltip" data-placement="left" title="夜间模式"><i class="mode-ico iconfont icon-night"></i></a>
            </div>
            <div class="footer-inner">
                <div class="footer-text">本站内容源自互联网，如有内容侵犯权益，请联系删除 | © <span id="footerYear"></span> 贻点导航</div>
            </div>
        </footer>
    </div>
</div>

<div class="modal fade search-modal" id="search-modal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div id="search-modal-box" class="s-search mx-auto my-4">
                    <form action="https://www.baidu.com/s" method="get" target="_blank" class="super-search-fm">
                        <input type="text" id="m_search-text" class="form-control smart-tips search-key" name="wd" autocomplete="off" placeholder="输入关键字搜索">
                        <button type="submit"><i class="iconfont icon-search"></i></button>
                    </form>
                    <div class="card search-smart-tips" style="display:none"><ul></ul></div>
                </div>
            </div>
            <div style="position:absolute;bottom:-40px;width:100%;text-align:center;">
                <a href="javascript:" data-dismiss="modal"><i class="iconfont icon-close-circle icon-2x" style="color:#fff;"></i></a>
            </div>
        </div>
    </div>
</div>

<script src="./assets/js/jquery.ui.touch-punch.min-0.2.2.js"></script>
<script src="./assets/js/clipboard.min-5.6.2.js"></script>
<script src="./assets/js/tooltip-extend.js"></script>
<script src="./assets/js/popper.min.js"></script>
<script src="./assets/js/bootstrap.min-4.3.1.js"></script>
<script src="./assets/js/theia-sticky-sidebar-1.5.0.js"></script>
<script src="./assets/js/lazyload.min-12.4.0.js"></script>
<script src="./assets/js/fancybox.min-3.5.7.js"></script>
<script src="./assets/js/app-anim.js"></script>
<script>
    const apiBase = '/api/public/home';
    const contentEl = document.getElementById('content');
    const sidebarEl = document.getElementById('sidebarMenu');
    const loadingTip = document.getElementById('loadingTip');
    const yearEl = document.getElementById('footerYear');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    function textSafe(str) {
        return (str || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderSidebar(categories) {
        if (!sidebarEl) return;
        sidebarEl.innerHTML = '';
        if (!categories || !categories.length) {
            sidebarEl.innerHTML = '<li class="sidebar-item text-muted px-3 py-2">暂无分类</li>';
            return;
        }
        categories.forEach(cat => {
            const hasChildren = Array.isArray(cat.children) && cat.children.length;
            const li = document.createElement('li');
            li.className = 'sidebar-item';
            const icon = cat.icon || 'fas fa-folder-open';
            li.innerHTML = `
                <a href="#cat-${cat.id}" class="${hasChildren ? 'smooth change-href' : 'smooth'}" ${hasChildren ? 'data-change="#cat-'+cat.id+'"' : ''}>
                    <i class="${icon} fa-lg icon-fw icon-lg mr-2"></i>
                    <span>${textSafe(cat.name)}</span>
                    ${hasChildren ? '<i class="iconfont icon-arrow-r-m sidebar-more text-sm"></i>' : ''}
                </a>
            `;
            if (hasChildren) {
                const ul = document.createElement('ul');
                cat.children.forEach(child => {
                    const cli = document.createElement('li');
                    cli.innerHTML = `<a href="#cat-${child.id}" class="smooth"><span>${textSafe(child.name)}</span></a>`;
                    ul.appendChild(cli);
                });
                li.appendChild(ul);
            }
            sidebarEl.appendChild(li);
        });
    }

    function renderCards(cards) {
        if (!cards || !cards.length) return '<div class="col-12 text-muted mb-3">暂无链接</div>';
        return cards.map(card => {
            const logo = card.logo || (card.url ? `${new URL(card.url, location.href).origin}/favicon.ico` : '');
            const desc = textSafe(card.description || '');
            const title = textSafe(card.title || card.name || '');
            const url = card.url || '#';
            return `
                <div class="url-card col-6 col-sm-6 col-md-4 col-xl-5a col-xxl-6a">
                    <div class="url-body default">
                        <a href="${url}" target="_blank" class="card no-c mb-4" data-toggle="tooltip" data-placement="bottom" data-original-title="${desc}">
                            <div class="card-body">
                                <div class="url-content d-flex align-items-center">
                                    <div class="url-img mr-2 d-flex align-items-center justify-content-center">
                                        ${logo ? `<img class="lazy" src="${logo}" onerror="this.src='assets/images/logos/default.webp'" alt="${title}">` : '<span class="badge gray">Logo</span>'}
                                    </div>
                                    <div class="url-info flex-fill">
                                        <div class="text-sm overflowClip_1"><strong>${title}</strong></div>
                                        <p class="overflowClip_1 m-0 text-muted text-xs">${desc || '暂无描述'}</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <a href="${url}" class="togo text-center text-muted is-views" target="_blank" title="直达" rel="nofollow"><i class="iconfont icon-goto"></i></a>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderSections(categories) {
        if (!categories || !categories.length) {
            return '<div class="text-center text-muted py-5">暂无分类数据</div>';
        }
        return categories.map(cat => `
            <div class="d-flex flex-fill">
                <h4 class="text-gray text-lg mb-4">
                    <i class="site-tag iconfont icon-tag icon-lg mr-1" id="cat-${cat.id}"></i>${textSafe(cat.name)}
                </h4>
            </div>
            <div class="row">${renderCards(cat.cards || [])}</div>
            ${cat.children ? cat.children.map(sub => `
                <div class="d-flex flex-fill mt-4">
                    <h5 class="text-gray text-md mb-3">
                        <i class="site-tag iconfont icon-dot mr-1" id="cat-${sub.id}"></i>${textSafe(sub.name)}
                    </h5>
                </div>
                <div class="row">${renderCards(sub.cards || [])}</div>
            `).join('') : ''}
        `).join('');
    }

    function renderFriends(friends) {
        if (!friends || !friends.length) return '';
        return `
            <div class="panel card bg-white p-3" id="friendlink">
                <div class="d-flex flex-fill mb-3 align-items-center">
                    <h4 class="text-gray text-lg mb-0"><i class="site-tag iconfont icon-link mr-1"></i>友情链接</h4>
                </div>
                <div class="row">
                    ${friends.map(f => `
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
                            <a class="btn btn-block btn-light d-flex align-items-center" href="${f.url || '#'}" target="_blank">
                                ${f.logo ? `<img src="${f.logo}" alt="${textSafe(f.name)}" style="width:24px;height:24px;border-radius:6px;object-fit:cover;" class="mr-2">` : '<i class="iconfont icon-link mr-2"></i>'}
                                <span class="text-truncate">${textSafe(f.name || '')}</span>
                            </a>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderHome(data) {
        if (!contentEl) return;
        const html = `
            ${renderSections(data.categories || [])}
            ${renderFriends(data.friends || [])}
        `;
        contentEl.innerHTML = html;
        if (loadingTip) loadingTip.remove();
    }

    async function loadHome() {
        try {
            const res = await fetch(apiBase);
            const data = await res.json();
            if (data && data.success) {
                renderSidebar(data.data?.categories || []);
                renderHome(data.data || {});
            } else {
                contentEl.innerHTML = '<div class="text-center text-muted py-5">数据加载失败</div>';
            }
        } catch (e) {
            console.error(e);
            contentEl.innerHTML = '<div class="text-center text-muted py-5">无法连接服务器</div>';
        }
    }

    function switchNightMode(){
        const body = document.body;
        const isNight = body.classList.contains('io-black-mode');
        if (isNight) {
            body.classList.remove('io-black-mode');
            body.classList.add('io-grey-mode');
        } else {
            body.classList.remove('io-grey-mode');
            body.classList.add('io-black-mode');
        }
    }

    document.addEventListener('DOMContentLoaded', loadHome);

    // 左侧分类折叠/展开
    document.addEventListener('click', (e) => {
        const link = e.target.closest('.sidebar-item > a.change-href');
        if (!link) return;
        const li = link.parentElement;
        const sub = li.querySelector('ul');
        if (sub) {
            e.preventDefault();
            li.classList.toggle('open');
            const isOpen = li.classList.contains('open');
            sub.style.display = isOpen ? 'block' : 'none';
        }
    });
</script>
</body>
</html>
